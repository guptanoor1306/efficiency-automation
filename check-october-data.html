<!DOCTYPE html>
<html>
<head>
    <title>Check October 2025 Data - All Teams</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        h1 {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }
        h2 {
            color: #764ba2;
            margin-top: 30px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background: #f8f9fa;
        }
        .efficiency {
            font-weight: bold;
            font-size: 16px;
            padding: 5px 10px;
            border-radius: 4px;
        }
        .high { background: #d4edda; color: #155724; }
        .medium { background: #fff3cd; color: #856404; }
        .low { background: #f8d7da; color: #721c24; }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin: 10px 5px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .summary {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }
        .warning {
            background: #fff3cd;
            border-left-color: #ffc107;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .error {
            background: #f8d7da;
            border-left-color: #dc3545;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        pre {
            background: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Check October 2025 Data - All Teams</h1>
        <p>This tool checks what data is actually stored in Supabase and shows the efficiency calculations for all teams.</p>
        
        <button onclick="checkAllTeams()">üîÑ Check All Teams' October Data</button>
        <button onclick="checkNoorData()">üë§ Check Noor's Product Data</button>
        
        <div id="output"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const { createClient } = supabase;
        const supabaseClient = createClient(
            'https://ygazzjwpazxekyqnsrsi.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlnYXp6andwYXp4ZWt5cW5zcnNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczMjYwNTQsImV4cCI6MjA3MjkwMjA1NH0.t96cTbq_Yc3-FCMvPYTBoD_eQVTuTE9yKPlaKNHTGY4'
        );

        const OCTOBER_WEEKS = [
            '2025-W40',  // Week 40: Sep 30 - Oct 3 (4 days in Oct)
            '2025-W41',  // Week 41: Oct 6-10 (5 days)
            '2025-W42',  // Week 42: Oct 13-17 (5 days)
            '2025-W43'   // Week 43: Oct 20-24 (5 days)
        ];

        const WEEK_WORKING_DAYS = {
            '2025-W40': 4,
            '2025-W41': 5,
            '2025-W42': 5,
            '2025-W43': 5
        };

        const ALL_TEAMS = [
            { id: 'product', name: 'Product Team', type: 'storypoints', targetPerDay: 1 },
            { id: 'tech', name: 'Tech Team', type: 'storypoints', targetPerDay: null },
            { id: 'b2b', name: 'B2B Team', type: 'days', targetPerDay: 1 },
            { id: 'varsity', name: 'Varsity Team', type: 'days', targetPerDay: 1 },
            { id: 'zero1_bratish', name: 'Zero1 Bratish', type: 'days', targetPerDay: 1 },
            { id: 'zero1_harish', name: 'Zero1 Harish', type: 'days', targetPerDay: 1 },
            { id: 'graphics', name: 'Graphics Team', type: 'days', targetPerDay: 1 },
            { id: 'audio', name: 'Audio Team', type: 'days', targetPerDay: 1 },
            { id: 'shorts', name: 'Shorts Team', type: 'days', targetPerDay: 1 },
            { id: 'preproduction', name: 'Preproduction', type: 'days', targetPerDay: 1 },
            { id: 'content', name: 'Content Team', type: 'storypoints', targetPerDay: 1 },
            { id: 'social', name: 'Social Team', type: 'storypoints', targetPerDay: 1 }
        ];

        async function checkNoorData() {
            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">üîÑ Loading Noor\'s October data from Supabase...</div>';

            try {
                const { data, error } = await supabaseClient
                    .from('weekly_entries')
                    .select('*')
                    .eq('team_id', 'product')
                    .eq('member_name', 'Noor')
                    .in('week_id', OCTOBER_WEEKS)
                    .order('week_id');

                if (error) throw error;

                let html = '<h2>üë§ Noor\'s October 2025 Data (Product Team)</h2>';
                
                if (!data || data.length === 0) {
                    html += '<div class="error">‚ùå No data found for Noor in October 2025!</div>';
                } else {
                    html += '<table>';
                    html += '<tr><th>Week</th><th>Working Days</th><th>Leave Days</th><th>Effective Days</th><th>Output (SP)</th><th>Target (SP)</th><th>Week Efficiency</th><th>Rating</th></tr>';
                    
                    let totalOutput = 0;
                    let totalWorkingDays = 0;
                    let totalLeaveDays = 0;
                    let totalEffectiveDays = 0;
                    
                    data.forEach(week => {
                        const workingDays = week.working_days || WEEK_WORKING_DAYS[week.week_id] || 5;
                        const leaveDays = week.leave_days || 0;
                        const effectiveDays = workingDays - leaveDays;
                        const output = week.week_total || 0;
                        const target = effectiveDays * 1; // Product team: 1 SP per effective day
                        const efficiency = target > 0 ? (output / target * 100) : 0;
                        
                        totalOutput += output;
                        totalWorkingDays += workingDays;
                        totalLeaveDays += leaveDays;
                        totalEffectiveDays += effectiveDays;
                        
                        const effClass = efficiency >= 95 ? 'high' : efficiency >= 75 ? 'medium' : 'low';
                        
                        html += `<tr>
                            <td><strong>${week.week_id}</strong></td>
                            <td>${workingDays}</td>
                            <td>${leaveDays}</td>
                            <td><strong>${effectiveDays.toFixed(1)}</strong></td>
                            <td>${output.toFixed(1)}</td>
                            <td>${target.toFixed(1)}</td>
                            <td class="efficiency ${effClass}">${efficiency.toFixed(1)}%</td>
                            <td>${week.weekly_rating || 0}</td>
                        </tr>`;
                    });
                    
                    const monthlyTarget = totalEffectiveDays * 1;
                    const monthlyEfficiency = monthlyTarget > 0 ? (totalOutput / monthlyTarget * 100) : 0;
                    const effClass = monthlyEfficiency >= 95 ? 'high' : monthlyEfficiency >= 75 ? 'medium' : 'low';
                    
                    html += '<tr style="background: #e9ecef; font-weight: bold;">';
                    html += '<td>MONTHLY TOTAL</td>';
                    html += `<td>${totalWorkingDays}</td>`;
                    html += `<td>${totalLeaveDays.toFixed(1)}</td>`;
                    html += `<td><strong>${totalEffectiveDays.toFixed(1)}</strong></td>`;
                    html += `<td>${totalOutput.toFixed(1)}</td>`;
                    html += `<td>${monthlyTarget.toFixed(1)}</td>`;
                    html += `<td class="efficiency ${effClass}">${monthlyEfficiency.toFixed(1)}%</td>`;
                    html += '<td>-</td>';
                    html += '</tr>';
                    html += '</table>';
                    
                    html += '<div class="summary">';
                    html += '<h3>üìä Calculation Breakdown</h3>';
                    html += '<p><strong>Formula for Product Team:</strong> (Total Story Points √∑ Total Effective Working Days) √ó 100</p>';
                    html += `<p><strong>Calculation:</strong> (${totalOutput.toFixed(1)} SP √∑ ${totalEffectiveDays.toFixed(1)} days) √ó 100 = ${monthlyEfficiency.toFixed(2)}%</p>`;
                    html += `<p><strong>Total Working Days:</strong> ${totalWorkingDays} days</p>`;
                    html += `<p><strong>Total Leave Days:</strong> ${totalLeaveDays.toFixed(1)} days</p>`;
                    html += `<p><strong>Total Effective Working Days:</strong> ${totalEffectiveDays.toFixed(1)} days (working - leave)</p>`;
                    html += `<p><strong>Total Output:</strong> ${totalOutput.toFixed(1)} story points</p>`;
                    html += `<p><strong>Target:</strong> ${monthlyTarget.toFixed(1)} story points (1 SP per effective day)</p>`;
                    html += '</div>';
                    
                    if (monthlyEfficiency < 95) {
                        html += '<div class="warning">';
                        html += '<strong>‚ö†Ô∏è Why is efficiency not 100%?</strong><br>';
                        html += `Noor completed ${totalOutput.toFixed(1)} story points but needed ${monthlyTarget.toFixed(1)} story points (1 SP per effective working day). `;
                        html += `The gap is ${(monthlyTarget - totalOutput).toFixed(1)} story points.`;
                        html += '</div>';
                    }
                    
                    html += '<h3>Raw Data from Supabase:</h3>';
                    html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                }
                
                output.innerHTML = html;
            } catch (error) {
                output.innerHTML = `<div class="error">‚ùå Error loading data: ${error.message}</div>`;
                console.error('Error:', error);
            }
        }

        async function checkAllTeams() {
            const output = document.getElementById('output');
            output.innerHTML = '<div class="loading">üîÑ Loading October 2025 data for all teams...</div>';

            let html = '<h2>üìä October 2025 - All Teams Summary</h2>';
            
            for (const team of ALL_TEAMS) {
                try {
                    const { data, error } = await supabaseClient
                        .from('weekly_entries')
                        .select('*')
                        .eq('team_id', team.id)
                        .in('week_id', OCTOBER_WEEKS);

                    if (error) throw error;

                    html += `<h3>${team.name} (${team.id})</h3>`;
                    
                    if (!data || data.length === 0) {
                        html += '<div class="warning">‚ö†Ô∏è No data found for this team in October 2025</div>';
                        continue;
                    }

                    // Group by member
                    const memberData = {};
                    data.forEach(entry => {
                        if (!memberData[entry.member_name]) {
                            memberData[entry.member_name] = [];
                        }
                        memberData[entry.member_name].push(entry);
                    });

                    html += '<table>';
                    html += '<tr><th>Member</th><th>Weeks</th><th>Working Days</th><th>Leave Days</th><th>Effective Days</th><th>Output</th><th>Target</th><th>Efficiency</th></tr>';

                    Object.keys(memberData).forEach(memberName => {
                        const weeks = memberData[memberName];
                        let totalOutput = 0;
                        let totalWorkingDays = 0;
                        let totalLeaveDays = 0;
                        let totalEffectiveDays = 0;
                        let totalTargetPoints = 0;

                        weeks.forEach(week => {
                            const workingDays = week.working_days || WEEK_WORKING_DAYS[week.week_id] || 5;
                            const leaveDays = week.leave_days || 0;
                            const effectiveDays = workingDays - leaveDays;
                            
                            totalOutput += week.week_total || 0;
                            totalWorkingDays += workingDays;
                            totalLeaveDays += leaveDays;
                            totalEffectiveDays += effectiveDays;

                            // For tech team, use target points
                            if (team.id === 'tech' && week.target_points) {
                                const adjustedTarget = week.target_points * (effectiveDays / workingDays);
                                totalTargetPoints += adjustedTarget;
                            }
                        });

                        let target, efficiency;
                        if (team.id === 'tech') {
                            target = totalTargetPoints;
                            efficiency = target > 0 ? (totalOutput / target * 100) : 0;
                        } else if (team.type === 'storypoints') {
                            target = totalEffectiveDays * (team.targetPerDay || 1);
                            efficiency = target > 0 ? (totalOutput / target * 100) : 0;
                        } else {
                            // Days-based teams
                            target = totalEffectiveDays;
                            efficiency = target > 0 ? (totalOutput / target * 100) : 0;
                        }

                        const effClass = efficiency >= 95 ? 'high' : efficiency >= 75 ? 'medium' : 'low';

                        html += `<tr>
                            <td><strong>${memberName}</strong></td>
                            <td>${weeks.length}</td>
                            <td>${totalWorkingDays}</td>
                            <td>${totalLeaveDays.toFixed(1)}</td>
                            <td><strong>${totalEffectiveDays.toFixed(1)}</strong></td>
                            <td>${totalOutput.toFixed(1)}</td>
                            <td>${target.toFixed(1)}</td>
                            <td class="efficiency ${effClass}">${efficiency.toFixed(1)}%</td>
                        </tr>`;
                    });

                    html += '</table>';

                } catch (error) {
                    html += `<div class="error">‚ùå Error loading ${team.name}: ${error.message}</div>`;
                }
            }

            output.innerHTML = html;
        }
    </script>
</body>
</html>

